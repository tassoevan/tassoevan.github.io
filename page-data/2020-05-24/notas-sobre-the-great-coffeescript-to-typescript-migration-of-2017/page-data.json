{"componentChunkName":"component---src-templates-post-js","path":"/2020-05-24/notas-sobre-the-great-coffeescript-to-typescript-migration-of-2017/","result":{"data":{"mdx":{"frontmatter":{"title":"Notas sobre \"The Great CoffeeScript to Typescript Migration of 2017\"","date":"2020-05-23T22:01:01.000Z","formattedDate":"23 de maio de 2020 às 22:01"},"excerpt":"Fonte:  https://dropbox.tech/frontend/the-great-coffeescript-to-typescript-migration-of-2017 Pré-história: adoção de CoffeeScript Em 2012, o…","timeToRead":5,"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Notas sobre \\\"The Great CoffeeScript to Typescript Migration of 2017\\\"\",\n  \"date\": \"2020-05-23T22:01:01.000Z\",\n  \"published\": true\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Fonte: \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://dropbox.tech/frontend/the-great-coffeescript-to-typescript-migration-of-2017\"\n  }), \"https://dropbox.tech/frontend/the-great-coffeescript-to-typescript-migration-of-2017\")), mdx(\"h2\", null, \"Pr\\xE9-hist\\xF3ria: ado\\xE7\\xE3o de CoffeeScript\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Em 2012, o Dropbox era uma startup com 150 funcion\\xE1rios.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"ES5 e jQuery dominavam o desenvolvimento JavaScript.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A codebase consistia de cerca de 100 mil linhas de JavaScript empacotada por simples concatena\\xE7\\xE3o de arquivos.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Dois engenheiros migraram tudo para CoffeeScript em uma semana.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Em 2013, adotaram o sistema de m\\xF3dulos RequireJS (AMD) j\\xE1 que CommonJS era restrita a Node e, portanto, n\\xE3o projetada para uso no browser.\")), mdx(\"h2\", null, \"Rumores de uma mudan\\xE7a de linguagem\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Ao final de 2015, ES6 j\\xE1 tinha mais funcionalidades que CoffeeScript.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Alguns times come\\xE7aram a adotar ES6 em projetos isolados.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A codebase era dif\\xEDcil de manter pois as t\\xE9cnicas de codifica\\xE7\\xE3o defensiva eram insuficientes e prejudicavam a legibilidade do c\\xF3digo.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Por CoffeeScript ser menos estrita que Python no uso de whitespaces, alguns engenheiros verificavam manualmente o c\\xF3digo JavaScript gerado; \\xE9 citado um bug s\\xE9rio no outono de 2013 causado por um espa\\xE7o em branco mal-posicionado.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Uma pesquisa interna em novembro de 2015 verificou que 62% dos desenvolvedores gostariam de mudar a linguagem utilizada.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Problemas com CoffeeScript apontados:\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Falta de delimitadores\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"em\", {\n    parentName: \"li\"\n  }, \"Syntactic sugar\"), \" muito opinativo\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Falta de suporte da comunidade\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Leitura dif\\xEDcil pois a sintaxe \\xE9 muito densa\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Sujeita a erros por causa de ambiguidades sint\\xE1ticas\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"O ferramental de TypeScript parecia melhor que vanilla ES6 + Flow no final de 2015.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"No primeiro semestre de 2016, um engenheiro integrou Babel e TypeScript.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Tanto o time quanto a codebase (330 mil linhas) haviam crescido significativamente para uma migra\\xE7\\xE3o indolor.\")), mdx(\"h2\", null, \"Um plano de migra\\xE7\\xE3o otimista\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Foram estabelecidas cinco \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"milestones\"), \" a serem cumpridas at\\xE9 julho de 2017:\\nM1. Suporte b\\xE1sico a TypeScript com interoperabilidade com CoffeeScript e ferramentas de i18n, lint e testes;\\nM2. Documentar boas pr\\xE1ticas e guias de migra\\xE7\\xE3o e migrar as principais bibliotecas e m\\xF3dulos para TypeScript ser a linguagem padr\\xE3o de desenvolvimento;\\nM3. Consolidar a \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"milestone\"), \" anterior migrando o restante de m\\xF3dulos e bibliotecas;\\nM4. Migrar os arquivos mais modificados ao longo do tempo no projeto;\\nM5. Remover o compilador de CoffeeScript.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"M1, M2 e M3 foram executadas no segundo semestre de 2016.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"M4 e M5 foram mais problem\\xE1ticas; esperava-se que o c\\xF3digo ficaria a cargo dos times que o desenvolveram originalmente.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"20% do time de produto foi alocado para trabalhar nas \\\"funda\\xE7\\xF5es\\\" da codebase.\")), mdx(\"h2\", null, \"Interoperabilidade de CoffeeScript/TypeScript\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Para cada arquivo de CoffeeScript (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"*.coffee\"), \"), foi criado um arquivo de declara\\xE7\\xF5es (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"*.d.ts\"), \") exportando os m\\xF3dulos como \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"any\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"M\\xF3dulos em TS com \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"export default value;\"), \" eram importados nos m\\xF3dulos AMD como objetos do tipo \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"{ default: value }\"), \"; named exports foram migrados com poucos problemas.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Em m\\xF3dulos cujos exports eram dinamicamente determinados, exportou-se todos os identificadores poss\\xEDveis mas com valores \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"undefined\"), \" dinamicamente determinados.\")), mdx(\"h2\", null, \"Banindo novos arquivos em CoffeeScript\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Foi criado um teste autom\\xE1tico para barrar a adi\\xE7\\xE3o de novos arquivos.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Este teste quebrou quando uma migra\\xE7\\xE3o paralela para \", mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://bazel.build/\"\n  }), \"Bazel\"), \" como sistema de build foi executada, pois a lista de arquivos \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"*.coffee\"), \" estava vazia.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Como aprendizado, testes passaram a fazer asser\\xE7\\xF5es em suposi\\xE7\\xF5es (neste caso, de que a lista nunca seria vazia).\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A redu\\xE7\\xE3o da \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"whitelist\"), \" de arquivos permitidos gerava pequenos atrasos no code review.\")), mdx(\"h2\", null, \"Experi\\xEAncia inicial: n\\xE3o perdemos o \", mdx(\"em\", {\n    parentName: \"h2\"\n  }, \"syntactic sugar\"), \" do CoffeeScript\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A perda de \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"optional chaining\"), \" e \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"nullish coalescing\"), \" foi compensada com a adi\\xE7\\xE3o de tipagem.\")), mdx(\"h2\", null, \"Prioridades concorrentes\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"No final de 2016, foi criado um time para redesign e reescrita do website em React (\\\"Maestro\\\").\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"O time do Maestro n\\xE3o conseguiu cumprir o prazo do primeiro trimestre, entregando ao t\\xE9rmino do segundo o projeto completo em React e TypeScript.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A lista de arquivos que deveria ser eliminada na M4 estagnou em 100 arquivos, mas na pr\\xE1tica ainda haviam 2000 arquivos em CoffeeScript com manuten\\xE7\\xE3o constante.\")), mdx(\"h2\", null, \"Adiando a M5\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Interpretou-se erroneamente que os scripts restantes deveriam ser substitu\\xEDdos pelos arquivos compilados, causando problemas com lint e i18n.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"N\\xE3o ficou claro que o objetivo da M5 era reduzir o custo (j\\xE1 pago) de manter o ferramental de CoffeeScript e TypeScript.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A migra\\xE7\\xE3o perdeu seu ETA.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A estimativa inicial da migra\\xE7\\xE3o era de 1000 linhas por dia demandando um ano de trabalho de um \\xFAnico engenheiro; na pr\\xE1tica, 100 linhas por dia eram convertidas, significando um tempo de 10 anos ou o trabalho de 10 engenheiros em um ano.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"N\\xE3o havia clareza sobre o que era o trabalho \\\"fundamental\\\" que demandaria 20% do time: se infraestrutura ou pagamento de d\\xEDvida t\\xE9cnica.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Uma migra\\xE7\\xE3o de sistemas em produ\\xE7\\xE3o para uma nova distribui\\xE7\\xE3o do Ubuntu tomou boa parte da m\\xE3o-de-obra de infraestrutura.\")), mdx(\"h2\", null, \"Um novo plano com \", mdx(\"inlineCode\", {\n    parentName: \"h2\"\n  }, \"decaffeinate\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Em janeiro de 2017, foi sugerido o uso de \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"decaffeinate\"), \" para as convers\\xF5es.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Uma fun\\xE7\\xE3o de ordena\\xE7\\xE3o com i18n n\\xE3o-testada quebrou completamente uma p\\xE1gina no browser Safari.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A longa lista de bugs semelhantes no \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"decaffeinate\"), \" obrigou se adotar uma convers\\xE3o mista (manual e autom\\xE1tica) que eventualmente ocasiona erros a n\\xEDvel de sem\\xE2ntica do c\\xF3digo.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Seis meses depois, \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"decaffeinate\"), \" parecia suficientemente maduro em compara\\xE7\\xE3o \\xE0 convers\\xE3o manual.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"O time entrou em acordo: TypeScript apenas com o tipo \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"any\"), \" era prefer\\xEDvel a CoffeeScript n\\xE3o-tipado e habilitaria os times a introduzirem tipos no seu pr\\xF3prio ritmo.\")), mdx(\"h2\", null, \"Um plano em duas fases\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A pipeline de migra\\xE7\\xE3o de c\\xF3digo consistia de m\\xFAltiplas etapas:\", mdx(\"ol\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Convers\\xE3o para JavaScript ES6;\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Transforma\\xE7\\xF5es com \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"codemod\"), \", especialmente de fun\\xE7\\xF5es com binding para \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"arrow functions\"), \";\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Transforma\\xE7\\xE3o da API legada de React para JSX;\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Convers\\xE3o de AMD para m\\xF3dulos ES (especial cuidado com exports);\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Anota\\xE7\\xE3o de par\\xE2metros de fun\\xE7\\xE3o com \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"any\"), \";\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Adi\\xE7\\xE3o de declara\\xE7\\xE3o de membros de classes;\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Anota\\xE7\\xE3o de componentes com tipos espec\\xEDficos de React;\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Adi\\xE7\\xE3o de coment\\xE1rio explicado como olhar o c\\xF3digo CoffeeScript original atrav\\xE9s do \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"git\"), \";\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A etapa final de corre\\xE7\\xE3o dos tipos envolveu escrever scripts para interpretar os erros vindos do \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"type checking\"), \" e aplicar as corre\\xE7\\xF5es automaticamente.\")), mdx(\"h2\", null, \"Mantendo o foco\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"O compromisso de manter uma ferramenta suficientemente boa tornou trivial resolver manualmente problemas como vari\\xE1veis mortas.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Agrupar a quantidade de erros do \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"tsc\"), \" por c\\xF3digo de erro gerou uma m\\xE9trica para a migra\\xE7\\xE3o e confian\\xE7a de que estavam na dire\\xE7\\xE3o correta.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"A taxa de erros por arquivo ficou entre 0,5 e 1.\")), mdx(\"h2\", null, \"Ganhando confian\\xE7a nas suas ferramentas\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Bugs pr\\xE9-existentes eram capturados rodando testes antes e ap\\xF3s as convers\\xF5es.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Se um erro ocorria em muitos lugares, uma asser\\xE7\\xE3o era adicionada \\xE0 pipeline de migra\\xE7\\xE3o em vez de realizar corre\\xE7\\xE3o manual.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Um bug not\\xE1vel destes \\xE9 relacionado a CoffeeScript n\\xE3o ter suporte a \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"variable shadowing\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"O c\\xF3digo foi inteiramente portado para o \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"strict mode\"), \" sem problemas como atribui\\xE7\\xE3o em propriedades \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"read-only\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"As primeiras convers\\xF5es em massa foram feitas nos testes autom\\xE1ticos.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Uma boa configura\\xE7\\xE3o do \", mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://www.youtube.com/watch?v=muvU1DYrY0w\"\n  }), \"itest\"), \" permitia checar rapidamente quais modifica\\xE7\\xF5es eram a origem dos problemas.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Foi importante ter rigor na escrita das tradu\\xE7\\xF5es de c\\xF3digo, cobrindo todos os \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"corner cases\"), \" e explicitando quais casos eram ignorados.\")), mdx(\"h2\", null, \"A \\xFAltima parte\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Nas \\xFAltimas semanas as ferramentas eram capazes de converter entre 100 e 200 arquivos numa \\xFAnica passagem.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Um dos truques para iterar rapidamente \\xE9 rodar o \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"typecheck\"), \" incremental (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"tsc --noEmit --watch\"), \").\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"O n\\xFAmero de arquivos em CoffeeScript era mantido atualizado num quadro branco.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Apenas dois bugs entraram em produ\\xE7\\xE3o.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Ao time mais resistente \\xE0 mudan\\xE7a foi prometido que erros ficariam a cargo dos engenheiros envolvidos na migra\\xE7\\xE3o.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Ao se admitir como produto um c\\xF3digo TypeScript n\\xE3o-idiom\\xE1tico, foram gastos 2 meses de trabalho de tr\\xEAs engenheiros (cerca de 19 engenheiros-semana).\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\\"N\\xF3s devemos economizar nosso capital pol\\xEDtico e organizacional com trabalhos que n\\xE3o podemos automatizar para todos\\\"; assim, a convers\\xE3o manual foi descartada.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Atualmente, o time da Dropbox mant\\xE9m 2kk linhas de TypeScript.\")));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"slug":"/2020-05-24/notas-sobre-the-great-coffeescript-to-typescript-migration-of-2017/","next":{"slug":"/2020-05-23/uma-sugestao-para-simular-um-e-paper/","title":"Uma sugestão para simular um e-paper"}}}}