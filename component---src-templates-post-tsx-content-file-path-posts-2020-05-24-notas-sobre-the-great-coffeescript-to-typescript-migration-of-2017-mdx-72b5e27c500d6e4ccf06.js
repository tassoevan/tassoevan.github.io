"use strict";(self.webpackChunk_tassoevan_tassoevan_github_io=self.webpackChunk_tassoevan_tassoevan_github_io||[]).push([[379],{3961:function(e,a,n){n.r(a),n.d(a,{default:function(){return d}});var t=n(8453),o=n(6540);function l(e){const a=Object.assign({p:"p",h2:"h2",ul:"ul",li:"li",em:"em",code:"code",a:"a",ol:"ol"},(0,t.R)(),e.components);return o.createElement(o.Fragment,null,o.createElement(a.p,null,"Fonte: https://dropbox.tech/frontend/the-great-coffeescript-to-typescript-migration-of-2017"),"\n",o.createElement(a.h2,null,"Pré-história: adoção de CoffeeScript"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Em 2012, o Dropbox era uma startup com 150 funcionários."),"\n",o.createElement(a.li,null,"ES5 e jQuery dominavam o desenvolvimento JavaScript."),"\n",o.createElement(a.li,null,"A codebase consistia de cerca de 100 mil linhas de JavaScript empacotada por simples concatenação de arquivos."),"\n",o.createElement(a.li,null,"Dois engenheiros migraram tudo para CoffeeScript em uma semana."),"\n",o.createElement(a.li,null,"Em 2013, adotaram o sistema de módulos RequireJS (AMD) já que CommonJS era restrita a Node e, portanto, não projetada para uso no browser."),"\n"),"\n",o.createElement(a.h2,null,"Rumores de uma mudança de linguagem"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Ao final de 2015, ES6 já tinha mais funcionalidades que CoffeeScript."),"\n",o.createElement(a.li,null,"Alguns times começaram a adotar ES6 em projetos isolados."),"\n",o.createElement(a.li,null,"A codebase era difícil de manter pois as técnicas de codificação defensiva eram insuficientes e prejudicavam a legibilidade do código."),"\n",o.createElement(a.li,null,"Por CoffeeScript ser menos estrita que Python no uso de whitespaces, alguns engenheiros verificavam manualmente o código JavaScript gerado; é citado um bug sério no outono de 2013 causado por um espaço em branco mal-posicionado."),"\n",o.createElement(a.li,null,"Uma pesquisa interna em novembro de 2015 verificou que 62% dos desenvolvedores gostariam de mudar a linguagem utilizada."),"\n",o.createElement(a.li,null,"Problemas com CoffeeScript apontados:","\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Falta de delimitadores"),"\n",o.createElement(a.li,null,o.createElement(a.em,null,"Syntactic sugar")," muito opinativo"),"\n",o.createElement(a.li,null,"Falta de suporte da comunidade"),"\n",o.createElement(a.li,null,"Leitura difícil pois a sintaxe é muito densa"),"\n",o.createElement(a.li,null,"Sujeita a erros por causa de ambiguidades sintáticas"),"\n"),"\n"),"\n",o.createElement(a.li,null,"O ferramental de TypeScript parecia melhor que vanilla ES6 + Flow no final de 2015."),"\n",o.createElement(a.li,null,"No primeiro semestre de 2016, um engenheiro integrou Babel e TypeScript."),"\n",o.createElement(a.li,null,"Tanto o time quanto a codebase (330 mil linhas) haviam crescido significativamente para uma migração indolor."),"\n"),"\n",o.createElement(a.h2,null,"Um plano de migração otimista"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Foram estabelecidas cinco ",o.createElement(a.em,null,"milestones")," a serem cumpridas até julho de 2017:\nM1. Suporte básico a TypeScript com interoperabilidade com CoffeeScript e ferramentas de i18n, lint e testes;\nM2. Documentar boas práticas e guias de migração e migrar as principais bibliotecas e módulos para TypeScript ser a linguagem padrão de desenvolvimento;\nM3. Consolidar a ",o.createElement(a.em,null,"milestone")," anterior migrando o restante de módulos e bibliotecas;\nM4. Migrar os arquivos mais modificados ao longo do tempo no projeto;\nM5. Remover o compilador de CoffeeScript."),"\n",o.createElement(a.li,null,"M1, M2 e M3 foram executadas no segundo semestre de 2016."),"\n",o.createElement(a.li,null,"M4 e M5 foram mais problemáticas; esperava-se que o código ficaria a cargo dos times que o desenvolveram originalmente."),"\n",o.createElement(a.li,null,'20% do time de produto foi alocado para trabalhar nas "fundações" da codebase.'),"\n"),"\n",o.createElement(a.h2,null,"Interoperabilidade de CoffeeScript/TypeScript"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Para cada arquivo de CoffeeScript (",o.createElement(a.code,null,"*.coffee"),"), foi criado um arquivo de declarações (",o.createElement(a.code,null,"*.d.ts"),") exportando os módulos como ",o.createElement(a.code,null,"any"),"."),"\n",o.createElement(a.li,null,"Módulos em TS com ",o.createElement(a.code,null,"export default value;")," eram importados nos módulos AMD como objetos do tipo ",o.createElement(a.code,null,"{ default: value }"),"; named exports foram migrados com poucos problemas."),"\n",o.createElement(a.li,null,"Em módulos cujos exports eram dinamicamente determinados, exportou-se todos os identificadores possíveis mas com valores ",o.createElement(a.code,null,"undefined")," dinamicamente determinados."),"\n"),"\n",o.createElement(a.h2,null,"Banindo novos arquivos em CoffeeScript"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Foi criado um teste automático para barrar a adição de novos arquivos."),"\n",o.createElement(a.li,null,"Este teste quebrou quando uma migração paralela para ",o.createElement(a.a,{href:"https://bazel.build/"},"Bazel")," como sistema de build foi executada, pois a lista de arquivos ",o.createElement(a.code,null,"*.coffee")," estava vazia."),"\n",o.createElement(a.li,null,"Como aprendizado, testes passaram a fazer asserções em suposições (neste caso, de que a lista nunca seria vazia)."),"\n",o.createElement(a.li,null,"A redução da ",o.createElement(a.em,null,"whitelist")," de arquivos permitidos gerava pequenos atrasos no code review."),"\n"),"\n",o.createElement(a.h2,null,"Experiência inicial: não perdemos o ",o.createElement(a.em,null,"syntactic sugar")," do CoffeeScript"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"A perda de ",o.createElement(a.em,null,"optional chaining")," e ",o.createElement(a.em,null,"nullish coalescing")," foi compensada com a adição de tipagem."),"\n"),"\n",o.createElement(a.h2,null,"Prioridades concorrentes"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,'No final de 2016, foi criado um time para redesign e reescrita do website em React ("Maestro").'),"\n",o.createElement(a.li,null,"O time do Maestro não conseguiu cumprir o prazo do primeiro trimestre, entregando ao término do segundo o projeto completo em React e TypeScript."),"\n",o.createElement(a.li,null,"A lista de arquivos que deveria ser eliminada na M4 estagnou em 100 arquivos, mas na prática ainda haviam 2000 arquivos em CoffeeScript com manutenção constante."),"\n"),"\n",o.createElement(a.h2,null,"Adiando a M5"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Interpretou-se erroneamente que os scripts restantes deveriam ser substituídos pelos arquivos compilados, causando problemas com lint e i18n."),"\n",o.createElement(a.li,null,"Não ficou claro que o objetivo da M5 era reduzir o custo (já pago) de manter o ferramental de CoffeeScript e TypeScript."),"\n",o.createElement(a.li,null,"A migração perdeu seu ETA."),"\n",o.createElement(a.li,null,"A estimativa inicial da migração era de 1000 linhas por dia demandando um ano de trabalho de um único engenheiro; na prática, 100 linhas por dia eram convertidas, significando um tempo de 10 anos ou o trabalho de 10 engenheiros em um ano."),"\n",o.createElement(a.li,null,'Não havia clareza sobre o que era o trabalho "fundamental" que demandaria 20% do time: se infraestrutura ou pagamento de dívida técnica.'),"\n",o.createElement(a.li,null,"Uma migração de sistemas em produção para uma nova distribuição do Ubuntu tomou boa parte da mão-de-obra de infraestrutura."),"\n"),"\n",o.createElement(a.h2,null,"Um novo plano com ",o.createElement(a.code,null,"decaffeinate")),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Em janeiro de 2017, foi sugerido o uso de ",o.createElement(a.code,null,"decaffeinate")," para as conversões."),"\n",o.createElement(a.li,null,"Uma função de ordenação com i18n não-testada quebrou completamente uma página no browser Safari."),"\n",o.createElement(a.li,null,"A longa lista de bugs semelhantes no ",o.createElement(a.code,null,"decaffeinate")," obrigou se adotar uma conversão mista (manual e automática) que eventualmente ocasiona erros a nível de semântica do código."),"\n",o.createElement(a.li,null,"Seis meses depois, ",o.createElement(a.code,null,"decaffeinate")," parecia suficientemente maduro em comparação à conversão manual."),"\n",o.createElement(a.li,null,"O time entrou em acordo: TypeScript apenas com o tipo ",o.createElement(a.code,null,"any")," era preferível a CoffeeScript não-tipado e habilitaria os times a introduzirem tipos no seu próprio ritmo."),"\n"),"\n",o.createElement(a.h2,null,"Um plano em duas fases"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"A pipeline de migração de código consistia de múltiplas etapas:","\n",o.createElement(a.ol,null,"\n",o.createElement(a.li,null,"Conversão para JavaScript ES6;"),"\n",o.createElement(a.li,null,"Transformações com ",o.createElement(a.code,null,"codemod"),", especialmente de funções com binding para ",o.createElement(a.em,null,"arrow functions"),";"),"\n",o.createElement(a.li,null,"Transformação da API legada de React para JSX;"),"\n",o.createElement(a.li,null,"Conversão de AMD para módulos ES (especial cuidado com exports);"),"\n",o.createElement(a.li,null,"Anotação de parâmetros de função com ",o.createElement(a.code,null,"any"),";"),"\n",o.createElement(a.li,null,"Adição de declaração de membros de classes;"),"\n",o.createElement(a.li,null,"Anotação de componentes com tipos específicos de React;"),"\n",o.createElement(a.li,null,"Adição de comentário explicado como olhar o código CoffeeScript original através do ",o.createElement(a.code,null,"git"),";"),"\n"),"\n"),"\n",o.createElement(a.li,null,"A etapa final de correção dos tipos envolveu escrever scripts para interpretar os erros vindos do ",o.createElement(a.em,null,"type checking")," e aplicar as correções automaticamente."),"\n"),"\n",o.createElement(a.h2,null,"Mantendo o foco"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"O compromisso de manter uma ferramenta suficientemente boa tornou trivial resolver manualmente problemas como variáveis mortas."),"\n",o.createElement(a.li,null,"Agrupar a quantidade de erros do ",o.createElement(a.code,null,"tsc")," por código de erro gerou uma métrica para a migração e confiança de que estavam na direção correta."),"\n",o.createElement(a.li,null,"A taxa de erros por arquivo ficou entre 0,5 e 1."),"\n"),"\n",o.createElement(a.h2,null,"Ganhando confiança nas suas ferramentas"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Bugs pré-existentes eram capturados rodando testes antes e após as conversões."),"\n",o.createElement(a.li,null,"Se um erro ocorria em muitos lugares, uma asserção era adicionada à pipeline de migração em vez de realizar correção manual."),"\n",o.createElement(a.li,null,"Um bug notável destes é relacionado a CoffeeScript não ter suporte a ",o.createElement(a.em,null,"variable shadowing"),"."),"\n",o.createElement(a.li,null,"O código foi inteiramente portado para o ",o.createElement(a.em,null,"strict mode")," sem problemas como atribuição em propriedades ",o.createElement(a.em,null,"read-only"),"."),"\n",o.createElement(a.li,null,"As primeiras conversões em massa foram feitas nos testes automáticos."),"\n",o.createElement(a.li,null,"Uma boa configuração do ",o.createElement(a.a,{href:"https://www.youtube.com/watch?v=muvU1DYrY0w"},"itest")," permitia checar rapidamente quais modificações eram a origem dos problemas."),"\n",o.createElement(a.li,null,"Foi importante ter rigor na escrita das traduções de código, cobrindo todos os ",o.createElement(a.em,null,"corner cases")," e explicitando quais casos eram ignorados."),"\n"),"\n",o.createElement(a.h2,null,"A última parte"),"\n",o.createElement(a.ul,null,"\n",o.createElement(a.li,null,"Nas últimas semanas as ferramentas eram capazes de converter entre 100 e 200 arquivos numa única passagem."),"\n",o.createElement(a.li,null,"Um dos truques para iterar rapidamente é rodar o ",o.createElement(a.em,null,"typecheck")," incremental (",o.createElement(a.code,null,"tsc --noEmit --watch"),")."),"\n",o.createElement(a.li,null,"O número de arquivos em CoffeeScript era mantido atualizado num quadro branco."),"\n",o.createElement(a.li,null,"Apenas dois bugs entraram em produção."),"\n",o.createElement(a.li,null,"Ao time mais resistente à mudança foi prometido que erros ficariam a cargo dos engenheiros envolvidos na migração."),"\n",o.createElement(a.li,null,"Ao se admitir como produto um código TypeScript não-idiomático, foram gastos 2 meses de trabalho de três engenheiros (cerca de 19 engenheiros-semana)."),"\n",o.createElement(a.li,null,'"Nós devemos economizar nosso capital político e organizacional com trabalhos que não podemos automatizar para todos"; assim, a conversão manual foi descartada.'),"\n",o.createElement(a.li,null,"Atualmente, o time da Dropbox mantém 2kk linhas de TypeScript."),"\n"))}var r=function(e){void 0===e&&(e={});const{wrapper:a}=Object.assign({},(0,t.R)(),e.components);return a?o.createElement(a,e,o.createElement(l,e)):l(e)},i=n(4387),m=n(6008),c=n(9031),s=n(4615);function u(e){let{pageContext:a,data:n,children:t}=e;const{frontmatter:{title:l,date:r},slug:u,next:d}=a,{excerpt:p,timeToRead:E}=n.mdx;return o.createElement(o.Fragment,null,o.createElement(i.A,{title:l,description:p}),o.createElement(m.A,null,o.createElement(c.A,null),o.createElement(s.A,{slug:u,title:l,date:new Date(Date.parse(r)),timeToRead:Math.ceil(E),next:d},t)))}function d(e){return o.createElement(u,e,o.createElement(r,e))}},9031:function(e,a,n){var t=n(6540),o=n(7581),l=n(8864),r=n(4017);const i=o.default.nav.withConfig({displayName:"NavBar__StyledNavBar",componentId:"sc-yc90xv-0"})(["h1{font-size:1em;font-weight:normal;margin:0;}"]);a.A=function(){const{title:e,description:a}=(0,l.Q)();return t.createElement(i,null,t.createElement("h1",null,t.createElement(r.A,{href:"/",title:a},e)))}},8453:function(e,a,n){n.d(a,{R:function(){return r}});var t=n(6540);const o={},l=t.createContext(o);function r(e){const a=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-posts-2020-05-24-notas-sobre-the-great-coffeescript-to-typescript-migration-of-2017-mdx-72b5e27c500d6e4ccf06.js.map