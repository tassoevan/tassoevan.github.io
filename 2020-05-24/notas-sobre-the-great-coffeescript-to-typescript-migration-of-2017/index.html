<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.f7dff9d2a25c98a7146d.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}html{font-size:62.5%;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif}body{font-size:1.8rem;line-height:1.618;max-width:38em;margin:auto;color:#4a4a4a;background-color:#f9f9f9;padding:13px}@media (max-width:684px){body{font-size:1.53rem}}@media (max-width:382px){body{font-size:1.35rem}}h1,h2,h3,h4,h5,h6{line-height:1.1;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif;font-weight:700;overflow-wrap:break-word;word-wrap:break-word;-ms-word-break:break-all;word-break:break-word;-ms-hyphens:auto;-webkit-hyphens:auto;hyphens:auto}h1{font-size:2.35em}h2{font-size:2em}h3{font-size:1.75em}h4{font-size:1.5em}h5{font-size:1.25em}h6{font-size:1em}small,sub,sup{font-size:75%}hr{border-color:#2c8898}a{text-decoration:none;color:#2c8898}a:hover{color:#982c61;border-bottom:2px solid #4a4a4a}ul{padding-left:1.4em}li{margin-bottom:.4em}blockquote{font-style:italic;margin-left:1.5em;padding-left:1em;border-left:3px solid #2c8898}img{height:auto;max-width:100%}pre{display:block;padding:1em;overflow-x:auto}code,pre{background-color:#f1f1f1}code{font-size:.9em;padding:0 .5em;white-space:pre-wrap}pre>code{padding:0;background-color:transparent;white-space:pre}table{text-align:justify;width:100%;border-collapse:collapse}td,th{padding:.5em;border-bottom:1px solid #f1f1f1}input,textarea{border:1px solid #4a4a4a}input:focus,textarea:focus{border:1px solid #2c8898}textarea{width:100%}.button,button,input[type=button],input[type=reset],input[type=submit]{display:inline-block;padding:5px 10px;text-align:center;text-decoration:none;white-space:nowrap;background-color:#2c8898;color:#f9f9f9;border-radius:1px;border:1px solid #2c8898;cursor:pointer;box-sizing:border-box}.button[disabled],button[disabled],input[type=button][disabled],input[type=reset][disabled],input[type=submit][disabled]{cursor:default;opacity:.5}.button:focus,.button:hover,button:focus,button:hover,input[type=button]:focus,input[type=button]:hover,input[type=reset]:focus,input[type=reset]:hover,input[type=submit]:focus,input[type=submit]:hover{background-color:#982c61;border-color:#982c61;color:#f9f9f9;outline:0}input[type],select,textarea{color:#4a4a4a;padding:6px 10px;margin-bottom:10px;background-color:#f1f1f1;border:1px solid #f1f1f1;border-radius:4px;box-shadow:none;box-sizing:border-box}input[type]:focus,select:focus,textarea:focus{border:1px solid #2c8898;outline:0}input[type=checkbox]:focus{outline:1px dotted #2c8898}fieldset,label,legend{display:block;margin-bottom:.5rem;font-weight:600}</style><meta name="generator" content="Gatsby 2.22.9"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">Notas sobre &quot;The Great CoffeeScript to Typescript Migration of 2017&quot; | Tasso &amp; As Vozes</title><meta data-react-helmet="true" name="description" content="Um lugar calmo e tranquilo onde dialogo com as vozes que habitam a minha cabeça"/><meta data-react-helmet="true" property="og:title" content="Notas sobre &quot;The Great CoffeeScript to Typescript Migration of 2017&quot;"/><meta data-react-helmet="true" property="og:description" content="Um lugar calmo e tranquilo onde dialogo com as vozes que habitam a minha cabeça"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator"/><meta data-react-helmet="true" name="twitter:title" content="Notas sobre &quot;The Great CoffeeScript to Typescript Migration of 2017&quot;"/><meta data-react-helmet="true" name="twitter:description" content="Um lugar calmo e tranquilo onde dialogo com as vozes que habitam a minha cabeça"/><style data-styled="fVazzd Eeomz gLqRHV jJNLaa" data-styled-version="4.4.1">
/* sc-component-id: sc-global-1074187945 */
body{font-family:"Lucida Sans Typewriter","Lucida Console",Monaco,"Bitstream Vera Sans Mono",monospace;max-width:unset;} h1,h2,h3,h4,h5,h6{font-family:inherit;font-weight:500;}
/* sc-component-id: Layout__BodyTitle-ivn37c-0 */
.fVazzd{display:none;}
/* sc-component-id: Post__StyledPost-sc-22n9ff-0 */
.gLqRHV{max-width:38em;margin:0 auto;}
/* sc-component-id: Post__NextArticle-sc-22n9ff-1 */
.jJNLaa{border-top:1pt dashed currentColor;text-align:right;text-align:end;}
/* sc-component-id: NavBar__StyledNavBar-cvp94v-0 */
.Eeomz h1{font-size:1em;font-weight:normal;}</style><link rel="icon" href="/favicon-32x32.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#91d2fa"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=42ab339d2b4e0c60236ff892cb3a4d78"/><link as="script" rel="preload" href="/webpack-runtime-747ae4aeabac7a5f887e.js"/><link as="script" rel="preload" href="/framework-dd95e8b3d258d85252e9.js"/><link as="script" rel="preload" href="/app-a775f5fe01c6374a94d4.js"/><link as="script" rel="preload" href="/styles-823ae8103e36ae8a7f9f.js"/><link as="script" rel="preload" href="/commons-e827d239f9a23482f6e0.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-306afd1d1591cab8fe87.js"/><link as="fetch" rel="preload" href="/page-data/2020-05-24/notas-sobre-the-great-coffeescript-to-typescript-migration-of-2017/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><h1 class="Layout__BodyTitle-ivn37c-0 fVazzd">Tasso &amp; As Vozes</h1><nav class="NavBar__StyledNavBar-cvp94v-0 Eeomz"><h1><a title="Um lugar calmo e tranquilo onde dialogo com as vozes que habitam a minha cabeça" href="/">Tasso &amp; As Vozes</a></h1></nav><div class="Post__StyledPost-sc-22n9ff-0 gLqRHV"><header><h2><a aria-current="page" class="" href="/2020-05-24/notas-sobre-the-great-coffeescript-to-typescript-migration-of-2017/">Notas sobre &quot;The Great CoffeeScript to Typescript Migration of 2017&quot;</a></h2><div><time dateTime="2020-05-23T22:01:01.000Z">23 de maio de 2020 às 22:01</time> ·<!-- --> <!-- -->6<!-- --> <!-- -->minutos</div></header><article><p>Fonte: <a href="https://dropbox.tech/frontend/the-great-coffeescript-to-typescript-migration-of-2017">https://dropbox.tech/frontend/the-great-coffeescript-to-typescript-migration-of-2017</a></p><h2>Pré-história: adoção de CoffeeScript</h2><ul><li>Em 2012, o Dropbox era uma startup com 150 funcionários.</li><li>ES5 e jQuery dominavam o desenvolvimento JavaScript.</li><li>A codebase consistia de cerca de 100 mil linhas de JavaScript empacotada por simples concatenação de arquivos.</li><li>Dois engenheiros migraram tudo para CoffeeScript em uma semana.</li><li>Em 2013, adotaram o sistema de módulos RequireJS (AMD) já que CommonJS era restrita a Node e, portanto, não projetada para uso no browser.</li></ul><h2>Rumores de uma mudança de linguagem</h2><ul><li>Ao final de 2015, ES6 já tinha mais funcionalidades que CoffeeScript.</li><li>Alguns times começaram a adotar ES6 em projetos isolados.</li><li>A codebase era difícil de manter pois as técnicas de codificação defensiva eram insuficientes e prejudicavam a legibilidade do código.</li><li>Por CoffeeScript ser menos estrita que Python no uso de whitespaces, alguns engenheiros verificavam manualmente o código JavaScript gerado; é citado um bug sério no outono de 2013 causado por um espaço em branco mal-posicionado.</li><li>Uma pesquisa interna em novembro de 2015 verificou que 62% dos desenvolvedores gostariam de mudar a linguagem utilizada.</li><li>Problemas com CoffeeScript apontados:<ul><li>Falta de delimitadores</li><li><em>Syntactic sugar</em> muito opinativo</li><li>Falta de suporte da comunidade</li><li>Leitura difícil pois a sintaxe é muito densa</li><li>Sujeita a erros por causa de ambiguidades sintáticas</li></ul></li><li>O ferramental de TypeScript parecia melhor que vanilla ES6 + Flow no final de 2015.</li><li>No primeiro semestre de 2016, um engenheiro integrou Babel e TypeScript.</li><li>Tanto o time quanto a codebase (330 mil linhas) haviam crescido significativamente para uma migração indolor.</li></ul><h2>Um plano de migração otimista</h2><ul><li>Foram estabelecidas cinco <em>milestones</em> a serem cumpridas até julho de 2017:
M1. Suporte básico a TypeScript com interoperabilidade com CoffeeScript e ferramentas de i18n, lint e testes;
M2. Documentar boas práticas e guias de migração e migrar as principais bibliotecas e módulos para TypeScript ser a linguagem padrão de desenvolvimento;
M3. Consolidar a <em>milestone</em> anterior migrando o restante de módulos e bibliotecas;
M4. Migrar os arquivos mais modificados ao longo do tempo no projeto;
M5. Remover o compilador de CoffeeScript.</li><li>M1, M2 e M3 foram executadas no segundo semestre de 2016.</li><li>M4 e M5 foram mais problemáticas; esperava-se que o código ficaria a cargo dos times que o desenvolveram originalmente.</li><li>20% do time de produto foi alocado para trabalhar nas &quot;fundações&quot; da codebase.</li></ul><h2>Interoperabilidade de CoffeeScript/TypeScript</h2><ul><li>Para cada arquivo de CoffeeScript (<code>*.coffee</code>), foi criado um arquivo de declarações (<code>*.d.ts</code>) exportando os módulos como <code>any</code>.</li><li>Módulos em TS com <code>export default value;</code> eram importados nos módulos AMD como objetos do tipo <code>{ default: value }</code>; named exports foram migrados com poucos problemas.</li><li>Em módulos cujos exports eram dinamicamente determinados, exportou-se todos os identificadores possíveis mas com valores <code>undefined</code> dinamicamente determinados.</li></ul><h2>Banindo novos arquivos em CoffeeScript</h2><ul><li>Foi criado um teste automático para barrar a adição de novos arquivos.</li><li>Este teste quebrou quando uma migração paralela para <a href="https://bazel.build/">Bazel</a> como sistema de build foi executada, pois a lista de arquivos <code>*.coffee</code> estava vazia.</li><li>Como aprendizado, testes passaram a fazer asserções em suposições (neste caso, de que a lista nunca seria vazia).</li><li>A redução da <em>whitelist</em> de arquivos permitidos gerava pequenos atrasos no code review.</li></ul><h2>Experiência inicial: não perdemos o <em>syntactic sugar</em> do CoffeeScript</h2><ul><li>A perda de <em>optional chaining</em> e <em>nullish coalescing</em> foi compensada com a adição de tipagem.</li></ul><h2>Prioridades concorrentes</h2><ul><li>No final de 2016, foi criado um time para redesign e reescrita do website em React (&quot;Maestro&quot;).</li><li>O time do Maestro não conseguiu cumprir o prazo do primeiro trimestre, entregando ao término do segundo o projeto completo em React e TypeScript.</li><li>A lista de arquivos que deveria ser eliminada na M4 estagnou em 100 arquivos, mas na prática ainda haviam 2000 arquivos em CoffeeScript com manutenção constante.</li></ul><h2>Adiando a M5</h2><ul><li>Interpretou-se erroneamente que os scripts restantes deveriam ser substituídos pelos arquivos compilados, causando problemas com lint e i18n.</li><li>Não ficou claro que o objetivo da M5 era reduzir o custo (já pago) de manter o ferramental de CoffeeScript e TypeScript.</li><li>A migração perdeu seu ETA.</li><li>A estimativa inicial da migração era de 1000 linhas por dia demandando um ano de trabalho de um único engenheiro; na prática, 100 linhas por dia eram convertidas, significando um tempo de 10 anos ou o trabalho de 10 engenheiros em um ano.</li><li>Não havia clareza sobre o que era o trabalho &quot;fundamental&quot; que demandaria 20% do time: se infraestrutura ou pagamento de dívida técnica.</li><li>Uma migração de sistemas em produção para uma nova distribuição do Ubuntu tomou boa parte da mão-de-obra de infraestrutura.</li></ul><h2>Um novo plano com <code>decaffeinate</code></h2><ul><li>Em janeiro de 2017, foi sugerido o uso de <code>decaffeinate</code> para as conversões.</li><li>Uma função de ordenação com i18n não-testada quebrou completamente uma página no browser Safari.</li><li>A longa lista de bugs semelhantes no <code>decaffeinate</code> obrigou se adotar uma conversão mista (manual e automática) que eventualmente ocasiona erros a nível de semântica do código.</li><li>Seis meses depois, <code>decaffeinate</code> parecia suficientemente maduro em comparação à conversão manual.</li><li>O time entrou em acordo: TypeScript apenas com o tipo <code>any</code> era preferível a CoffeeScript não-tipado e habilitaria os times a introduzirem tipos no seu próprio ritmo.</li></ul><h2>Um plano em duas fases</h2><ul><li>A pipeline de migração de código consistia de múltiplas etapas:<ol><li>Conversão para JavaScript ES6;</li><li>Transformações com <code>codemod</code>, especialmente de funções com binding para <em>arrow functions</em>;</li><li>Transformação da API legada de React para JSX;</li><li>Conversão de AMD para módulos ES (especial cuidado com exports);</li><li>Anotação de parâmetros de função com <code>any</code>;</li><li>Adição de declaração de membros de classes;</li><li>Anotação de componentes com tipos específicos de React;</li><li>Adição de comentário explicado como olhar o código CoffeeScript original através do <code>git</code>;</li></ol></li><li>A etapa final de correção dos tipos envolveu escrever scripts para interpretar os erros vindos do <em>type checking</em> e aplicar as correções automaticamente.</li></ul><h2>Mantendo o foco</h2><ul><li>O compromisso de manter uma ferramenta suficientemente boa tornou trivial resolver manualmente problemas como variáveis mortas.</li><li>Agrupar a quantidade de erros do <code>tsc</code> por código de erro gerou uma métrica para a migração e confiança de que estavam na direção correta.</li><li>A taxa de erros por arquivo ficou entre 0,5 e 1.</li></ul><h2>Ganhando confiança nas suas ferramentas</h2><ul><li>Bugs pré-existentes eram capturados rodando testes antes e após as conversões.</li><li>Se um erro ocorria em muitos lugares, uma asserção era adicionada à pipeline de migração em vez de realizar correção manual.</li><li>Um bug notável destes é relacionado a CoffeeScript não ter suporte a <em>variable shadowing</em>.</li><li>O código foi inteiramente portado para o <em>strict mode</em> sem problemas como atribuição em propriedades <em>read-only</em>.</li><li>As primeiras conversões em massa foram feitas nos testes automáticos.</li><li>Uma boa configuração do <a href="https://www.youtube.com/watch?v=muvU1DYrY0w">itest</a> permitia checar rapidamente quais modificações eram a origem dos problemas.</li><li>Foi importante ter rigor na escrita das traduções de código, cobrindo todos os <em>corner cases</em> e explicitando quais casos eram ignorados.</li></ul><h2>A última parte</h2><ul><li>Nas últimas semanas as ferramentas eram capazes de converter entre 100 e 200 arquivos numa única passagem.</li><li>Um dos truques para iterar rapidamente é rodar o <em>typecheck</em> incremental (<code>tsc --noEmit --watch</code>).</li><li>O número de arquivos em CoffeeScript era mantido atualizado num quadro branco.</li><li>Apenas dois bugs entraram em produção.</li><li>Ao time mais resistente à mudança foi prometido que erros ficariam a cargo dos engenheiros envolvidos na migração.</li><li>Ao se admitir como produto um código TypeScript não-idiomático, foram gastos 2 meses de trabalho de três engenheiros (cerca de 19 engenheiros-semana).</li><li>&quot;Nós devemos economizar nosso capital político e organizacional com trabalhos que não podemos automatizar para todos&quot;; assim, a conversão manual foi descartada.</li><li>Atualmente, o time da Dropbox mantém 2kk linhas de TypeScript.</li></ul></article><footer class="Post__NextArticle-sc-22n9ff-1 jJNLaa"><a href="/2020-05-23/uma-sugestao-para-simular-um-e-paper/">Uma sugestão para simular um e-paper</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-31191590-3', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020-05-24/notas-sobre-the-great-coffeescript-to-typescript-migration-of-2017/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-a775f5fe01c6374a94d4.js"],"component---src-pages-index-js":["/component---src-pages-index-js-79395609861504fb0a10.js"],"component---src-templates-post-js":["/component---src-templates-post-js-306afd1d1591cab8fe87.js"]};/*]]>*/</script><script src="/component---src-templates-post-js-306afd1d1591cab8fe87.js" async=""></script><script src="/commons-e827d239f9a23482f6e0.js" async=""></script><script src="/styles-823ae8103e36ae8a7f9f.js" async=""></script><script src="/app-a775f5fe01c6374a94d4.js" async=""></script><script src="/framework-dd95e8b3d258d85252e9.js" async=""></script><script src="/webpack-runtime-747ae4aeabac7a5f887e.js" async=""></script></body></html>